# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Test Commands

```bash
# Build
go build -o votigo .

# Run tests
go test ./...

# Run single test
go test ./internal/db -run TestMigrate -v

# Regenerate sqlc queries after modifying queries.sql
sqlc generate

# Cross-compile
GOOS=windows GOARCH=amd64 go build -o votigo.exe .
GOOS=linux GOARCH=amd64 go build -o votigo-linux .
```

## Architecture Overview

Votigo is a server-rendered voting web app designed to work on ancient browsers (IE 6-7, Netscape) as well as modern devices. It provides both CLI admin tools and a web interface.

### Key Design Constraints

- **No JavaScript required** - all functionality works via server-rendered HTML
- **HTML 4.01 Transitional** - table-based layouts, no CSS3
- **Pure Go SQLite** - uses `modernc.org/sqlite` (no CGO) for easy cross-compilation

### Project Structure

```
main.go                 # Kong CLI entry point
cmd/
  root.go              # CLI struct definitions and AfterApply hook
  category.go          # Category list/create commands
  option.go            # Option add/list/remove commands
  lifecycle.go         # open/close commands
  results.go           # Results display command
  serve.go             # Web server command
internal/
  db/
    connect.go         # Open() and Migrate() functions
    queries.sql        # sqlc query definitions
    schema.sql         # Schema for sqlc (mirrors migration)
    queries.sql.go     # Generated by sqlc
    models.go          # Generated by sqlc
  web/
    server.go          # HTTP server, all handlers, template loading
templates/
  embed.go             # Template embed.FS
  layout.html          # Base HTML 4.01 layout
  home.html            # Voter home page
  vote.html            # Voting form (single/approval/ranked)
  results.html         # Results display
  error.html           # Error page
  admin/
    dashboard.html     # Admin category list
    category.html      # Create/edit category with options
migrations/
  embed.go             # Migration embed.FS
  00001_initial_schema.sql  # Database schema with indexes
```

### Data Flow

1. **CLI commands** use Kong for parsing. `AfterApply` hook in `cmd/root.go` opens DB and runs migrations before any command executes.

2. **Database access** via sqlc-generated `*db.Queries`. All queries defined in `internal/db/queries.sql`.

3. **Web server** in `internal/web/server.go` handles all routes. Templates loaded via embed.FS at startup.

4. **Voting types**: single (radio buttons), approval (checkboxes), ranked (dropdowns with point-based tallying).

### sqlc Workflow

Schema and queries are defined in SQL, then sqlc generates type-safe Go code:

```bash
# After modifying internal/db/queries.sql or internal/db/schema.sql:
sqlc generate
```

Note: `schema.sql` must stay in sync with `migrations/00001_initial_schema.sql`.

### Template Rendering

Templates use Go's `html/template`. Each page template is combined with `layout.html` at load time. The `{{define "content"}}` block in page templates is rendered within the layout.

Template function `add` is available for arithmetic in templates (used for ranked voting display).

### Vote Submission Flow

1. Voter enters nickname and makes selections
2. POST to `/vote/{id}` validates input
3. Transaction: upsert vote record, delete old selections, insert new selections
4. Nickname normalized to lowercase for duplicate detection
5. Re-voting replaces previous vote (same nickname = same voter)
